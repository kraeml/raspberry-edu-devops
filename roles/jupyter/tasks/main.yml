---
# tasks file for jupyter

- name: Install jupyter dependencies
  become: yes
  package:
      state: present
      name: "{{dependencies_packages}}"

- name: Pip3 Version
  command: pip3 --version
  register: pip3_version
  ignore_errors: yes
  changed_when: False

- name: Ensure pip3 is installed
  become: yes
  package:
    state: present
    name: python3-pip
  when: pip3_version|failed

- name: Ensure Jupyter and some kernel/extensions are installed
  become: yes
  pip:
    name: "{{item}}"
    executable: pip3
    state: present
  with_items: "{{pip3_packages}}"

- name: Ensure bash kernel is installed
  become: yes
  command: python3 -m bash_kernel.install
  args:
    creates: /usr/local/share/jupyter/kernels/bash

- name: Ensure ijavascript ist installed
  become: yes
  npm:
      name: ijavascript
      global: yes
      state: present # The state of the node.js library

- name: Ensure ijavascript kernel is installed
  become: yes
  command: /usr/bin/ijsinstall --install=global
  args:
    creates: /usr/local/share/jupyter/kernels/javascript

- name: Get nbextensions
  command: jupyter nbextension list
  register: jupyter_nbextensions
  changed_when: False

- name: Display nbextension
  debug:
      var: jupyter_nbextensions
      verbosity: 2

- name: Ensure widgetsnbextension activated
  become: yes
  command: jupyter nbextension enable --py --sys-prefix widgetsnbextension
  when: not (jupyter_nbextensions.stdout.find("jupyter-js-widgets/extension \u001b[32m enabled"))

- name: Ensure notebook directory exists
  file:
      path: "/home/pi/{{item}}"
      state: directory
  with_items:
      - notebooks
      - .jupyter

- name: Create jupyter config
  template:
      src: jupyter_notebook_config.py.j2
      dest: /home/pi/.jupyter/jupyter_notebook_config.py
  notify:
    - restart_jupyter

- name: Enable and start Jupyter as service
  become: yes
  template:
      src: jupyter.service.j2
      dest: /lib/systemd/system/jupyter.service
      mode: 0644
      owner: root
      group: root
  notify:
    - restart_jupyter
